{% extends "base.html" %}
{% block content %}
<div class="engagement-container">
    <h1>Engagement Dashboard</h1>

    <!-- Aggregation Selector -->
    <form id="periodForm" method="GET" action="/engagement" style="margin-bottom: 20px;">
        <label for="periodSelect">Aggregation Period:</label>
        <select name="period" id="periodSelect" onchange="document.getElementById('periodForm').submit()">
            <option value="day" {% if request.args.get('period') == 'day' %}selected{% endif %}>Daily</option>
            <option value="week" {% if request.args.get('period') == 'week' %}selected{% endif %}>Weekly</option>
            <option value="month" {% if request.args.get('period') == 'month' or not request.args.get('period') %}selected{% endif %}>Monthly</option>
            <option value="quarter" {% if request.args.get('period') == 'quarter' %}selected{% endif %}>Quarterly</option>
            <option value="year" {% if request.args.get('period') == 'year' %}selected{% endif %}>Yearly</option>
        </select>
    </form>

    <div class="button-wrapper">
        <button id="loadLikesBtn" class="load-btn">
            <span class="btn-text">Load Engagement Data</span>
            <span class="spinner" style="display: none;"></span>
        </button>
    </div>
    

    <!-- Chart + Text Pairs -->
    <div class="chart-row">
        <div class="chart-text">
            <h2>Engagement Rate Over Time</h2>
            <p>Engagement over time.</p>
        </div>
        <div class="chart-box">
            <canvas id="engagementOverTime"></canvas>
        </div>
    </div>
    <div class="chart-row">
        <div class="chart-text">
            <h2>Engagement Rate by Hour of Week</h2>
            <p>Engagement by hour of week.</p>
        </div>
        <div class="chart-box">
            <canvas id="engagementByHour"></canvas>
        </div>
    </div>
    <div class="chart-row">
        <div class="chart-text">
            <h2>Likes Cohort Curve</h2>
            <p>Likes Cohort Curve.</p>
        </div>
        <div class="chart-box">
            <canvas id="cohortCurve"></canvas>
        </div>
    </div>
</div>

<script>
let chart1, chart2, chart3;

document.getElementById("loadLikesBtn").addEventListener("click", function() {
    const btn = this;
    const text = btn.querySelector(".btn-text");
    const spinner = btn.querySelector(".spinner");
    const period = document.getElementById("periodSelect").value;

    btn.disabled = true;
    text.textContent = "Loading...";
    spinner.style.display = "inline-block";

    fetch(`/engagement/likes-data?period=${period}`)
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            text.textContent = "Reload Engagement Data";
            spinner.style.display = "none";
            renderCharts(data);
        })
        .catch(err => {
            btn.disabled = false;
            text.textContent = "Try Again";
            spinner.style.display = "none";
            alert("Failed to load engagement data.");
            console.error(err);
        });
});

function renderCharts(data) {
    const ctx1 = document.getElementById('engagementOverTime').getContext('2d');
    const ctx2 = document.getElementById('engagementByHour').getContext('2d');
    const ctx3 = document.getElementById('cohortCurve').getContext('2d');

    // Destroy old charts if they exist
    if (chart1) chart1.destroy();
    if (chart2) chart2.destroy();
    if (chart3) chart3.destroy();

    chart1 = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: data.engagement_over_time.labels,
            datasets: [{
                label: 'Engagement Rate',
                data: data.engagement_over_time.values,
                backgroundColor: 'rgba(75, 192, 192, 0.4)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2
            }]
        },
        options: chartOptions()
    });

    chart2 = new Chart(ctx2, {
        type: 'bar',
        data: data.engagement_by_hour,
        options: chartOptions()
    });

    chart3 = new Chart(ctx3, {
        type: 'line',
        data: data.cohort_curves,
        options: chartOptions()
    });
}

function chartOptions() {
    return {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(255,255,255,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(255,255,255,0.1)'
                }
            }
        },
        plugins: {
            legend: {
                labels: {
                    color: '#eee'
                }
            }
        }
    };
}
</script>
{% endblock %}
