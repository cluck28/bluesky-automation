{% extends "base.html" %}
{% block content %}
<div class="container my-4">

    <!-- Top Section -->
    <section class="queue-rules mb-5">
        <h2 class="mb-3">Queue Rules</h2>
        <form method="POST" action="{{ url_for('add_rule') }}">
            <div class="input-group">
                <input type="text" name="rule" class="form-control" placeholder="e.g., M/W/F at 10am" required>
                <button type="submit" class="btn btn-primary">Add Rule</button>
            </div>
        </form>
    </section>

    <!-- Middle Section -->
    <section class="queue-list bg-light p-4 rounded">
        <h2 class="mb-4">Upcoming Posts</h2>

        <div id="sortable-list">
            {% for media in media_items %}
            <div class="d-flex justify-content-center mb-4 sortable-item" data-id="{{ media.path }}">
                <div class="card shadow-sm d-flex flex-row align-items-center w-100" style="max-width: 700px;">
                    <img src="{{ url_for('static', filename=media.path) }}"
                         alt="media"
                         class="rounded-start"
                         style="width: 40%; height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title mb-2">{{ media.text or "No Text Added" }}</h5>
                        <p class="card-text text-muted mb-1">Scheduled: {{ media.date or "TBD" }}</p>
                        <p class="card-text small">Status: {{ media.status or "Pending" }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </section>
</div>

<script>
let sortableInstance; // Keep a single instance of Sortable

function initSortable() {
    const list = document.getElementById("sortable-list");

    if (!sortableInstance) {
        sortableInstance = Sortable.create(list, {
            animation: 150,
            handle: ".card",
            ghostClass: "sortable-ghost",
            onEnd: function(evt) {
                // Map the current order of items
                const order = Array.from(list.children)
                                   .filter(el => el.classList.contains("sortable-item"))
                                   .map(el => el.dataset.id);

                console.log("New order:", order);

                // Send to Flask backend
                fetch("/update_order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ order: order })
                })
                .then(response => response.text())
                .then(html => {
                    // Replace only the inner HTML of the list
                    list.innerHTML = html;
                    // No need to reinitialize Sortable since instance stays
                })
                .catch(err => console.error("Error updating order:", err));
            }
        });
    }
}

document.addEventListener("DOMContentLoaded", initSortable);
</script>

<style>
.sortable-ghost {
    opacity: 0.6;
    background: #e0e0e0;
}
</style>
{% endblock %}
