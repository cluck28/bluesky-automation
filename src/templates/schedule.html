{% extends "base.html" %}
{% block content %}
<div class="container my-4">

    <!-- Top Section -->
    <section class="queue-rules mb-5">
        <h2 class="mb-3">Queue Rules</h2>
        <form method="POST" action="{{ url_for('add_rule') }}">
            <div class="input-group">
                <input type="text" name="rule" class="form-control" placeholder="e.g., M/W/F at 10am" required>
                <button type="submit" class="btn btn-primary">Add Rule</button>
            </div>
        </form>
    </section>

    <!-- Middle Section -->
    <section class="queue-list bg-light p-4 rounded">
        <h2 class="mb-4">Upcoming Posts</h2>

        <div id="sortable-list">
            {% include "_sortable_list.html" %}
        </div>
    </section>
</div>

<script>
let sortableInstance;

function initEditable() {
    document.querySelectorAll(".editable-text").forEach(el => {
        el.addEventListener("blur", handleTextEdit);
        el.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                el.blur();
            }
        });
    });
}

function handleTextEdit(e) {
    const el = e.target;
    const id = el.closest(".sortable-item").dataset.id;
    const newText = el.textContent.trim();

    fetch("/update_text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: id, text: newText })
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById("sortable-list").innerHTML = html;
        initEditable(); // reattach text editing
    })
    .catch(err => console.error("Error updating text:", err));
}

function initSortable() {
    const list = document.getElementById("sortable-list");

    if (!sortableInstance) {
        sortableInstance = Sortable.create(list, {
            animation: 150,
            handle: ".card",
            ghostClass: "sortable-ghost",
            onEnd: function() {
                const order = Array.from(list.children)
                                   .filter(el => el.classList.contains("sortable-item"))
                                   .map(el => el.dataset.id);

                fetch("/update_order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ order: order })
                })
                .then(response => response.text())
                .then(html => {
                    list.innerHTML = html;
                    initEditable();
                })
                .catch(err => console.error("Error updating order:", err));
            }
        });
    }
}

document.addEventListener("DOMContentLoaded", () => {
    initSortable();
    initEditable();
});
</script>

<style>
.sortable-ghost { opacity: 0.6; background: #e0e0e0; }
.editable-text { border: 1px dashed transparent; padding: 2px; cursor: text; }
.editable-text:focus { outline: none; border-color: #007bff; background: #f0f8ff; }
</style>
{% endblock %}
